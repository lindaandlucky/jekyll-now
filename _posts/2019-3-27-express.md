# 2019-3-27-express.md

```js
npm i --save express 
--save 表示自动修改package.json文件，自动添加依赖项
```



## 路由

```js
用get请求访问一个网址
app.get('网址'，function(){
    
})
用post请求访问一个网址
app.post('网址'，function(){
    
})
如果项处理这个网址的任何方式的请求，那么写all
app.all('网址'，function(){
    
})
这里的网址不分大小写
所有的get参数，？后面的都已经被忽略。锚点#也被忽略
req.params是类数组对象
正则表达式可以被使用，正则表达式中，未知部分用圆括号分组，然后可以用req.params[0],[1]得到
冒号是更推荐的写法
app.get('/student/:id', function(req.res) {
    var id = req.params['id'];
    
})
```

### restful路由设计

```js
node.js非常适合restful.简单的说，就是一个路径，但是http的method不同，对这个页面的使用也不同
```

### 中间件

```js
如果我们的get，post回调函数中，没有next参数，那么就匹配上第一个路由，就不会往下匹配了,
如果想往下匹配的话，就必须使用next参数
app.get('/',function(res, req, next) {
    console.log('1');
    next();
})
app.get('/',function(res, req) {
    console.log('2');
})
```

下面这两个路由，感觉没有关系

```js
app.get('/:username/:id',function(res, req) {
    console.log('1');
})
app.get('/admin/login',function(res, req) {
    console.log('2');
})
```

但是实际上冲突了，因为admin可以当作用户名，login可以是ID

如何解决呢？

一 这两个函数可以换一下位置，也就是说，express中所有的路由（中间件）的顺序至关重要。匹配上第一个，就不会往下匹配了。具体的往上写，抽象的往下写

二  

```js
app.get('/:username/:id',function(res, req, next) {
    var username = req.params.username;
    // 检索数据库，如果username不存在，那么next（）
    if(username) {    
    } else {
        next()
    }
})
app.get('/admin/login',function(res, req) {
    console.log('2');
})
```

app.use也是一个中间件，与get，post不同，他的网址不是精确匹配的，而是能够有小文件夹拓展的

eg: http://127.0.0.1:3000/admin/aa/bb/cc

```js
app.use('/admin',function(req, res) {
    res.write(req.originalUrl) // /admin/aa/bb/cc
    res.write(req.baseUrl)  //   /admin
    res.write(req.path)     //   /aa/bb/cc
})
// 当你不写路径的时候，实际上相当于“/”，就是所有网址
app.use(function(req, res) {
    res.write(req.originalUrl) // /admin/aa/bb/cc
    res.write(req.baseUrl)  //   /admin
    res.write(req.path)     //   /aa/bb/cc
})

app.use(haha);
function haha(req,res,next) {
    var filePath = req.originalUrl;
    // 根据当前的网址，读取文件夹中的文件
    // 如果有这个文件，那么渲染这个文件
    // 如果没有这个文件，那么next()
    fs.readFile(filePath,function(err, data) {
        if(err) {
            // 文件不存在
            next()
            return
        }
        res.send(data.toString())
    })
}
app.use()给了我们一些特定功能的便利场所
实际上app.use()的东西，基本上从第三方能得到
// express会自动识别err参数，如果有，那么就表示这个函数能捕获err
app.use(function(req,res){
    
})
```

```js
大多数情况喜爱，渲染内容用res.render()，将会根据views中的模版文件进行渲染。如果不想使用views文件夹，想自己设置文件夹的名字，那么app.set('views',自己设置的文件夹名)
如果想写一个快速测试页，当然可以使用res.send（）。这个函数将根据内容，自动帮我们设置Content-Type头部和200状态码。res.send（）只能用一次，这一点和end一样
如果想使用不同的状态码，可以：
  res.status(404).send('dkfjfj')
如果想使用不同的Content-Type，可以：
  res.set('Content-Type', "text/html")
```

### 处理get，post请求参数

get请求的参数在URL中，在原生node中，需要使用url模块来识别参数字符串。在express中，不需要使用url模块，可以直接使用req.query对象

post请求在express中不能直接获得，必须使用body-parse模块。使用后，将可以使用req.body得到参数。但是如果表单中含有文件上传，那么还是需要formidable模块

node的编程思维就是所欲的东西都是异步的，所以，内层函数，不会return回来东西，而是调用高层函数提供的回调函数。把数据当作回调函数的参数来使用。

node中全是回调函数，如果我们自己封装的函数里面有异步的方法，比如I/O，那么就要用回调函数的方法封装